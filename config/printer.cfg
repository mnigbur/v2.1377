[include ../mainsail.cfg]

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 5000			        #Max 8600
max_z_velocity: 25			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 300
square_corner_velocity: 10.0


   


#####################################################################
#	Displays
#####################################################################

#--------------------------------------------------------------------

[display]
#	mini12864 LCD Display
lcd_type: uc1701
cs_pin: PC11
a0_pin: PD2
rst_pin: PC10
encoder_pins: ^PC6,^PC7
click_pin: ^!PA8
contrast: 63
spi_bus: spi1
#spi_software_mosi_pin: PA7
#spi_software_sclk_pin: PA5

[neopixel fysetc_mini12864]
#	To control Neopixel RGB in mini12864 display
pin: PC12
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

#	Set RGB values on boot up for each Neopixel. 
#	Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode setdisplayneopixel]
initial_duration: 1
gcode:
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

#--------------------------------------------------------------------




#####################################################################
#	Macros
#####################################################################

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    CG28
    QUAD_GANTRY_LEVEL
    G28
    G0 X150 Y150 Z20 F6000
   
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    {% set TEMP_BED = params.TEMP_BED|default(60)|float %}
    {% set TEMP_EXTRUDER = params.TEMP_EXTRUDER|default(190)|float %}

    G90 ; use absolute coordinates
    M83 ; extruder relative mode

    {% if 'temperature_fan exhaust' in printer %}
        SET_TEMPERATURE_FAN_TARGET temperature_fan=exhaust target={% if BED_TEMP|float <= 80 %}40{% else %}70{% endif %}
    {% endif %}

    M117 Bed heating..
    #M104 S{TEMP_EXTRUDER} ; set extruder temp
    M190 S{TEMP_BED} ; set bed temp

    M117 Nozzle heating..
    M109 S{TEMP_EXTRUDER} ; wait for extruder temp

    M117 Homing axis..
    G32 ; Home XYZ and do QGL

    PRIME_LINE

    BED_MESH_PROFILE LOAD=default
    G90 
    G92 E0.0
   
[gcode_macro PRIME_LINE]
default_parameter_X: 10 ; X-axis start position
default_parameter_Y: 3 ; Y-axis start position
default_parameter_AXIS: X ; axis direction for prime line
default_parameter_LAYER_HEIGHT: 0.2 ; prime line layer height
default_parameter_LENGTH: 200 ; line length in mm
default_parameter_WIDTH: 1.6 ; line width in mm
default_parameter_FILAMENT_WIDTH: 1.75 ; filament diameter in mm
default_parameter_SPEED: 16 ; line speed mm/s
default_parameter_RETRACTION_LENGTH: 0.5 ; mm retraction after line printed
default_parameter_RETRACTION_SPEED: 30 ; mm/s retraction speed after line printed
default_parameter_Z_LIFT: 10 ; z lift after primed line
default_parameter_WIPE_LENGTH: 2 ; wipe after intro line
gcode: |

    SAVE_GCODE_STATE NAME=prime_line_state
    {% set AXIS = AXIS|string|lower %}

    {% set PARK_SPEED = 200 %}

    M117 Intro line..
    G1 X{X|float} Y{Y|float} Z{LAYER_HEIGHT|float} F{(PARK_SPEED * 60)|int}; park
    G91
    G92 E0.0
    {% set FIRST_LENGTH = (LENGTH|float * 0.65)|round(2) %}
    {% set SECOND_LENGTH = (LENGTH|float - FIRST_LENGTH|float)|round(2) %}

    {% set filament_rate = WIDTH|float * LAYER_HEIGHT|float %}

    G1 {AXIS|upper}{FIRST_LENGTH|float} E{ ((filament_rate * FIRST_LENGTH)/FILAMENT_WIDTH|float)|float } F{(60*SPEED|int)|int} ; intro line
    G1 {AXIS|upper}{SECOND_LENGTH|float} E{ 1.25 * ((filament_rate * SECOND_LENGTH)/FILAMENT_WIDTH|float)|round(3) } F{(60*SPEED|int)|int} ; intro line

    {% if WIPE_LENGTH|int != 0 %}
        G1 {AXIS|upper}{WIPE_LENGTH|float} F{(60*SPEED|int)|int}
    {% endif %}

    {% if RETRACTION_LENGTH|float != 0 %}
        G92 E0.0
        G1 E{ (-1 * RETRACTION_LENGTH|float)} F{60 * RETRACTION_SPEED|int}
    {% endif %}

    {% if Z_LIFT|float > 0 %}
        G1 Z{Z_LIFT|float} F{(30*60)|int}
    {% endif %}

	M400

    RESTORE_GCODE_STATE NAME=prime_line_state MOVE=1 MOVE_SPEED={PARK_SPEED|int}

[gcode_macro PRINT_END]
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-3.0 F3600                 ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    
    M84 # Disable steppers

[gcode_macro CLEAR_SCREEN]
gcode: M117

# Conditional G28 (home if not already homed)
[gcode_macro CG28]
gcode:
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes or "z" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}

[gcode_macro test_speed_fast]
gcode:
        G28 X0 Y0
        GET_POSITION
        G1 X0 Y0     F27000
        G1 X300 Y300 F27000
        G1 X0 Y0     F27000
        G1 X300 Y300 F27000

        G1 X0 Y300 F36000

        G1 X300 Y0 F27000
        G1 X0 Y300 F27000
        G1 X300 Y0 F27000
        G1 X0 Y300 F27000

        G1 X0 Y0 F36000
        G1 X300 Y0 F36000
        G1 X300 Y300 F36000
        G1 X0 Y300 F36000
        G1 X0 Y0 F36000
        G28 X0 Y0
        GET_POSITION


